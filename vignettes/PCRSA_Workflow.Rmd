---
    title: "PCRSA Workflow"
author: "John Lawson"
date: "`r Sys.Date()`"
output: 
    BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{PCRSA Workflow}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---
    
    
This vignette is intended to be a script that can easily be modified for
your own PCRSA analysis. It is unevaluated because PCRSA normally involves 
large objects in memory.

# Inputs

1. PCA loadings (prcomp()$rotation).
2. Genomic coordinates associated with PCA loadings.
2. Region sets (normally a database of region sets).

To begin, let's load the necessary packages:
    
```{r, eval=FALSE, message=FALSE, warning=FALSE}
library(LOLA)
library(PCRSA)
library(data.table)
library(GenomicRanges)
library(ggplot2)
```

## Input 1: PCA Loadings and Genomic Coordinates

First, we need the results from PCA of the DNA methylation data. We will also need the genomic coordinates for each cytosine in the DNA methylation data. As one way of doing this, we could store the methlylation level matrix and the coordinates as items in a named list called "methylData". The first item in the list -- "coordinates" -- would be a GRanges object with coordinates for the cytosines (or alternatively a data.frame with "chr" and "start" columns). The second item in the list -- "methylProp" -- would be a matrix of the methylation levels, with cytosines as rows (same order as "coordinates") and samples as columns. We will assume that structure for the following code.   

```{r, eval=FALSE, message=FALSE, warning=FALSE}
# the genomic coordinates
mCoord = methylData$coordinates
# consider whether centering or scaling is needed
mPCA = prcomp(x = t(methylData$methylProp), center = TRUE, scale. = FALSE)
```

## Input 2: Large Collection of Region Sets

Besides the PCA results, we need region sets. Normally we should use PCRSA with a large collection of region sets. The collection of region sets can come from anywhere but we will use the LOLA region set databases which include region sets from public sources such as the ENCODE, Roadmap Epigenomics, and Cistrome Projects. Documentation on LOLA here: (http://bioconductor.org/packages/release/bioc/html/LOLA.html). Let's load the LOLA databases (this may take a minute): 
    
```{r, eval=FALSE, message=FALSE, warning=FALSE}
# reading in the region sets
# load LOLA database
lolaPath <- paste0("path/to/LOLACore/genomeVersion/") 
regionSetDB <- loadRegionDB(lolaPath)

# metadata about the region sets
loRegionAnno <- regionSetDB$regionAnno
lolaCoreRegionAnno <- loRegionAnno
collections <- c("cistrome_cistrome", "cistrome_epigenome", "encode_segmentation", 
                "encode_tfbs", "ucsc_features")
collectionInd <- lolaCoreRegionAnno$collection %in% collections
lolaCoreRegionAnno <- lolaCoreRegionAnno[collectionInd, ]
rsName <- lolaCoreRegionAnno$filename
rsDescription <- lolaCoreRegionAnno$description

# the actual region sets
GRList <- GRangesList(regionSetDB$regionGRL[collectionInd])

# since we have what we need, we can delete this to free up memory
rm("regionSetDB")
```


# PCRSA

Now we test how much each region set is associated with each principal component:
    
```{r, eval=FALSE, message=FALSE, warning=FALSE}
PCsToAnnotate = paste0("PC", 1:6)
rsEnrichment = pcRegionSetEnrichment(loadingMat=mPCA$rotation, 
                                     mCoord = mCoord, 
                                     GRList=GRList, 
                                     PCsToAnnotate = PCsToAnnotate, 
                                     scoringMetric="raw")
rsEnrichment$rsName = rsName
rsEnrichment$rsDescription = rsDescription
```

We can sort the results to see which region sets are most associated with each PC.

```{r, eval=FALSE, message=FALSE, warning=FALSE}
View(rsEnrichment[order(rsEnrichment$PC1, decreasing = TRUE), ])
View(rsEnrichment[order(rsEnrichment$PC2, decreasing = TRUE), ])
# etc.
```

